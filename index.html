<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCM Stock Manager (Bill Scanner)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';</script>

    <style>
        body { background-color: #f4f6f9; font-family: 'Poppins', sans-serif; padding-bottom: 80px; }
        .app-header { background: linear-gradient(180deg, #FF9933 0%, #ffffff 50%, #138808 100%); padding: 15px; border-bottom: 4px solid #000080; position: sticky; top: 0; z-index: 1000; text-align: center; }
        .header-title { font-weight: 800; color: #000080; margin: 0; }
        
        .upload-card { background: white; border-radius: 15px; padding: 20px; text-align: center; border: 2px dashed #007bff; margin-bottom: 20px; cursor: pointer; }
        .upload-icon { font-size: 40px; color: #007bff; margin-bottom: 10px; }
        
        .inventory-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .inventory-table th { background: #000080; color: white; padding: 12px; text-align: left; }
        .inventory-table td { padding: 12px; border-bottom: 1px solid #eee; }
        
        .stock-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; }
        .stock-ok { background: #e8f5e9; color: #2e7d32; }
        .stock-low { background: #ffebee; color: #c62828; }

        /* Modal */
        #confirmModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; max-height: 80vh; overflow-y: auto; }
        
        .list-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px; border-top: 3px solid #FF9933; }
        .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 0.8em; } .nav-item.active { color: #000080; font-weight: bold; }
    </style>
</head>
<body>

    <header class="app-header">
        <h5 class="header-title">RCM Stock Manager</h5>
        <small id="status" class="text-dark fw-bold">Connecting...</small>
    </header>

    <div class="container mt-3">
        
        <div id="view-upload" class="section-view">
            <h6 class="fw-bold mb-3">ðŸ“¥ Add Stock via Bill</h6>
            <div class="upload-card" onclick="document.getElementById('pdfInput').click()">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <h6 class="fw-bold">Upload RCM Bill (PDF)</h6>
                <small class="text-muted">Auto-detects Name, Qty & Rate</small>
            </div>
            <input type="file" id="pdfInput" hidden accept="application/pdf" onchange="parseBill(this)">
            
            <div class="alert alert-info small">
                <i class="fas fa-info-circle"></i> This will read "Krushnai Rcm Shoppy" bill format automatically.
            </div>
        </div>

        <div id="view-list" class="section-view" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold m-0">ðŸ“¦ Current Stock</h6>
                <button class="btn btn-sm btn-primary" onclick="loadStock()">Refresh</button>
            </div>
            <table class="inventory-table">
                <thead><tr><th>Product</th><th>Rate</th><th>Stock</th></tr></thead>
                <tbody id="stockTableBody">
                    <tr><td colspan="3" class="text-center p-3 text-muted">No products yet. Upload a bill!</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <div id="confirmModal">
        <div class="modal-box">
            <h5 class="fw-bold text-primary mb-3">Confirm Stock Entry</h5>
            <div id="scannedData" class="mb-3"></div>
            <div class="d-grid gap-2">
                <button class="btn btn-success" onclick="saveToFirebase()">âœ… Save to Stock</button>
                <button class="btn btn-secondary" onclick="document.getElementById('confirmModal').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <a class="nav-item active" onclick="switchView('view-upload', this)"><i class="fas fa-file-upload d-block fa-lg"></i> Upload</a>
        <a class="nav-item" onclick="switchView('view-list', this)"><i class="fas fa-boxes d-block fa-lg"></i> Stock List</a>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyAYfRLpyfVHNYFyTYZaSylGxyoW4UFH-yw", authDomain: "rcmcrm-5ad88.firebaseapp.com", projectId: "rcmcrm-5ad88", storageBucket: "rcmcrm-5ad88.firebasestorage.app", messagingSenderId: "172188965998", appId: "1:172188965998:web:33d65df1549fdb1acb1a7f" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        db.collection("test").get().then(()=>document.getElementById('status').innerText="â— Online").catch(()=>document.getElementById('status').innerText="Offline");

        let extractedItems = [];

        // --- 1. BILL PARSER (The Magic Logic) ---
        async function parseBill(input) {
            if (!input.files[0]) return;
            const file = input.files[0];
            const buffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(buffer).promise;
            let fullText = "";

            // Read all pages
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                fullText += content.items.map(item => item.str).join(" ") + " ";
            }

            console.log("Raw Text:", fullText); // Debugging

            // --- REGEX EXPLANATION FOR "Krushnai Rcm Shoppy" BILL ---
            // Pattern: [Name] [Qty] [Rate] ...
            // Name: Can contain letters, commas, numbers (e.g. "Soap, 38 g")
            // Qty: Integer (e.g. 2, 12)
            // Rate: Decimal (e.g. 8.00, 207.00)
            // We look for a Qty and Rate appearing together, and capture the text BEFORE it as the Name.
            
            extractedItems = [];
            const regex = /([a-zA-Z0-9\s,\.\-()%]+?)\s+(\d+)\s+(\d+\.\d{2})/g;
            
            let match;
            while ((match = regex.exec(fullText)) !== null) {
                let name = match[1].trim();
                let qty = parseInt(match[2]);
                let rate = parseFloat(match[3]);

                // Filter junk data (Headers, Footers)
                if (name.length > 3 && !name.includes("Total") && !name.includes("Amount") && !name.includes("Invoice") && !name.includes("Date")) {
                    
                    // Clean up name (sometimes captures extra spaces)
                    name = name.replace(/\s+/g, ' ').trim();
                    
                    extractedItems.push({ name, qty, rate });
                }
            }

            if (extractedItems.length === 0) {
                alert("No products found! Please check if the PDF is clear.");
            } else {
                showConfirmModal();
            }
        }

        // --- 2. SHOW CONFIRMATION ---
        function showConfirmModal() {
            const listDiv = document.getElementById('scannedData');
            listDiv.innerHTML = "";
            extractedItems.forEach(item => {
                listDiv.innerHTML += `
                <div class="list-item">
                    <div style="width:60%"><b>${item.name}</b><br><small>â‚¹${item.rate}</small></div>
                    <div class="text-success fw-bold">+${item.qty} Qty</div>
                </div>`;
            });
            document.getElementById('confirmModal').style.display = 'flex';
        }

        // --- 3. SAVE TO FIREBASE ---
        function saveToFirebase() {
            const batch = db.batch();
            
            extractedItems.forEach(item => {
                // Use Product Name as ID (Clean it first)
                const docId = item.name.replace(/\//g, "-"); 
                const ref = db.collection("inventory").doc(docId);
                
                batch.set(ref, {
                    name: item.name,
                    price: item.rate,
                    qty: firebase.firestore.FieldValue.increment(item.qty) // Add to existing
                }, { merge: true });
            });

            batch.commit().then(() => {
                document.getElementById('confirmModal').style.display = 'none';
                alert("Stock Updated Successfully! ðŸš€");
                switchView('view-list', document.querySelectorAll('.nav-item')[1]);
                loadStock();
            }).catch(e => alert("Error saving: " + e.message));
        }

        // --- 4. LOAD STOCK ---
        function loadStock() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">Loading...</td></tr>';
            
            db.collection("inventory").get().then(snap => {
                if(snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Inventory Empty</td></tr>';
                    return;
                }
                
                let html = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const badge = d.qty < 5 ? "stock-low" : "stock-ok";
                    html += `
                    <tr>
                        <td><b>${d.name}</b></td>
                        <td>â‚¹${d.price}</td>
                        <td><span class="stock-badge ${badge}">${d.qty}</span></td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            });
        }

        // --- UTILS ---
        function switchView(viewId, btn) {
            document.querySelectorAll('.section-view').forEach(el => el.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            if(viewId === 'view-list') loadStock();
        }
    </script>
</body>
</html>
